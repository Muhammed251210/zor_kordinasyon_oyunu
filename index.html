<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>N√∂ro Senkron 2.9</title>
    <style>
        /* --- TEMEL AYARLAR --- */
        html, body {
            margin: 0; padding: 0;
            background-color: #050505; color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden; height: 100%; width: 100%;
            touch-action: none; user-select: none;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }

        #gameContainer {
            position: relative; width: 100%; height: 100%;
            background: #000; overflow: hidden;
        }

        .pseudo-fullscreen {
            position: fixed !important; top: 0; left: 0; right: 0; bottom: 0;
            width: 100vw !important; height: 100vh !important;
            z-index: 99999; background: #000; margin: 0; padding: 0;
        }

        canvas {
            display: block; background: transparent; width: 100%; height: 100%;
            object-fit: contain; position: absolute; top: 0; left: 0;
        }

        /* --- UI KATMANLARI --- */
        #uiLayer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; 
            display: flex; justify-content: space-between;
            padding: 20px; box-sizing: border-box;
            z-index: 10;
        }

        .stats-box { text-align: center; width: 150px; font-family: 'Courier New', Courier, monospace; margin-top: 50px; }
        .score-val { font-size: 4vh; font-weight: 900; text-shadow: 0 0 10px currentColor; }
        .combo-val { font-size: 2vh; font-weight: bold; opacity: 0; transition: opacity 0.3s; color: #ffeb3b;}
        #p1Stats { color: #00ffff; text-align: left; }
        #p2Stats { color: #ff00ff; text-align: right; }
        
        #centerStats {
            position: absolute; top: 60px; left: 50%; transform: translateX(-50%);
            text-align: center;
        }
        #livesDisplay { font-size: 3vh; letter-spacing: 5px; text-shadow: 0 0 15px #ff0000; }

        #gamepadStatus {
            position: absolute; bottom: 150px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 255, 0, 0.2); border: 1px solid #00ff00; color: #00ff00;
            padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 0.8rem;
            display: none; animation: fadeIn 0.5s; z-index: 60; backdrop-filter: blur(2px);
        }

        /* --- BUTONLAR --- */
        #fullscreenBtn, #pauseBtn, #homeBtn {
            position: absolute; top: 15px;
            background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3);
            color: white; border-radius: 8px; cursor: pointer; z-index: 50;
            display: flex; justify-content: center; align-items: center;
            pointer-events: auto; transition: all 0.2s; backdrop-filter: blur(4px);
            width: 40px; height: 40px; font-size: 20px;
        }
        #fullscreenBtn:hover, #pauseBtn:hover, #homeBtn:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.1); }
        #pauseBtn { left: 20px; }
        #homeBtn { right: 20px; font-size: 24px; padding-bottom: 5px; }
        #fullscreenBtn { right: 70px; }
        
        /* --- MEN√úLER --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            pointer-events: auto; backdrop-filter: blur(10px); z-index: 40; text-align: center;
        }
        h1 { font-size: clamp(2rem, 5vw, 4rem); margin: 0 0 20px 0; background: linear-gradient(90deg, #00ffff, #ff00ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-transform: uppercase; letter-spacing: 3px; text-shadow: 0 0 30px rgba(0, 255, 255, 0.3); font-family: 'Courier New', Courier, monospace; font-weight: 900; }
        .menu-btn { padding: 15px 40px; font-size: 1.2rem; background: rgba(0,0,0,0.5); color: #fff; border: 2px solid #fff; border-radius: 5px; cursor: pointer; font-weight: bold; margin: 10px; transition: all 0.2s; min-width: 250px; position: relative; overflow: hidden; font-family: 'Courier New', Courier, monospace; }
        .menu-btn:hover, .menu-btn.selected { background: #fff; color: #000; transform: scale(1.05); box-shadow: 0 0 20px rgba(255,255,255,0.5); }
        
        .color-grid { display: flex; justify-content: center; gap: 15px; margin-top: 30px; flex-wrap: wrap; max-width: 800px; }
        .color-btn { width: 60px; height: 60px; border-radius: 10px; border: 3px solid #333; cursor: pointer; transition: transform 0.2s; box-sizing: border-box; display: flex; justify-content: center; align-items: center; font-size: 18px; font-weight: bold; color: rgba(0,0,0,0.5); }
        .color-btn.focused { transform: scale(1.2); border-color: #fff; box-shadow: 0 0 20px rgba(255,255,255,0.8); z-index: 2; color: #000; }
        .color-taken { opacity: 0.2; filter: grayscale(100%); transform: scale(0.8); }

        /* --- KONTROLLER (ALTA SABƒ∞TLENDƒ∞) --- */
        #controlsWrapper {
            position: absolute; bottom: 10px; left: 0; width: 100%;
            height: 120px; /* Y√ºkseklik sabitlendi */
            padding-bottom: 10px; pointer-events: none; z-index: 30;
            display: flex; justify-content: space-between; padding-left: 20px; padding-right: 20px; box-sizing: border-box;
            align-items: center;
        }
        .control-group { display: flex; gap: 15px; pointer-events: auto; align-items: flex-end; }
        .portrait-mode-controls { justify-content: center !important; width: 100%; }

        .btn {
            width: 75px; height: 75px;
            background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-size: 24px; color: rgba(255,255,255,0.7); cursor: pointer; backdrop-filter: blur(2px);
            transition: background 0.1s; touch-action: none;
        }
        .btn:active, .btn.active { background: rgba(255, 255, 255, 0.3); transform: scale(0.95); color: #fff; border-color: #fff; }
        .btn-fire { border-width: 3px; font-weight: bold; border-color: rgba(255, 50, 50, 0.5); color: #ffaaaa; }

        .hidden { display: none !important; }
        #divider { position: absolute; left: 50%; top: 0; bottom: 0; width: 1px; background: rgba(255,255,255,0.1); transform: translateX(-50%); transition: opacity 0.5s; }
        #pauseOverlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 3rem; font-weight: bold; text-shadow: 0 0 20px cyan; pointer-events: none; z-index: 100; display: none; font-family: 'Courier New', Courier, monospace; }
        .winner-table { width: 90%; max-width: 500px; border-collapse: collapse; margin: 20px 0; font-size: 1.2rem; font-family: 'Courier New', Courier, monospace; }
        .winner-table td { padding: 10px; border-bottom: 1px solid #444; }
        .winner-row { font-weight: bold; font-size: 1.5rem; color: gold; }
        @keyframes fadeIn { from { opacity: 0; transform: translate(-50%, 10px); } to { opacity: 1; transform: translate(-50%, 0); } }
    </style>
</head>
<body>

    <div id="gameContainer">
        <canvas id="bgCanvas" style="z-index: 1;"></canvas>
        <canvas id="gameCanvas" style="z-index: 2;"></canvas>
        <div id="divider" style="z-index: 3;"></div>
        
        <div id="gamepadStatus">üéÆ GAMEPAD BAƒûLANDI</div>
        <div id="pauseOverlay">PAUSED</div>

        <button id="pauseBtn" title="Durdur">‚ùö‚ùö</button>
        <button id="fullscreenBtn" title="Tam Ekran">‚õ∂</button>
        <button id="homeBtn" title="Ana Men√º">‚åÇ</button>
        
        <div id="uiLayer">
            <div id="p1Stats" class="stats-box">
                <div class="score-val" id="p1Score">0</div>
                <div class="combo-val" id="p1Combo">x1</div>
            </div>
            <div id="centerStats"><div id="livesDisplay">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div></div>
            <div id="p2Stats" class="stats-box">
                <div class="score-val" id="p2Score">0</div>
                <div class="combo-val" id="p2Combo">x1</div>
            </div>
        </div>

        <!-- KONTROLLER -->
        <div id="controlsWrapper">
            <div class="control-group left-group" id="leftControls">
                <div class="btn" data-key="z">‚óÄ</div>
                <div class="btn btn-fire" data-key="x">‚óè</div>
                <div class="btn" data-key="c">‚ñ∂</div>
            </div>
            <div class="control-group right-group" id="rightControls">
                <div class="btn" data-key="ArrowLeft">‚óÄ</div>
                <div class="btn btn-fire" data-key="ArrowDown">‚óè</div>
                <div class="btn" data-key="ArrowRight">‚ñ∂</div>
            </div>
        </div>

        <!-- MOD SE√áƒ∞Mƒ∞ -->
        <div id="modeScreen" class="screen">
            <h1>AIRFORCE <span style="font-size:0.5em; color:gold; vertical-align: super;">2.9</span></h1>
            <button class="menu-btn selected" id="btnMode1" onclick="selectMode(1)">1 OYUNCU<br><span style="font-size:0.6em;">Solo U√ßu≈ü</span></button>
            <button class="menu-btn" id="btnMode2" onclick="selectMode(2)">2 OYUNCU<br><span style="font-size:0.6em;">Hava D√ºellosu</span></button>
            <div style="margin-top:20px; color:#888; font-size:0.9em;">Kontroller: Klavye / Dokunmatik / Gamepad</div>
        </div>

        <!-- RENK SE√áƒ∞Mƒ∞ -->
        <div id="colorScreen" class="screen hidden">
            <h1 id="colorTitle">U√ßak Rengi</h1>
            <div class="color-grid" id="colorGrid"></div>
            <div style="margin-top: 30px; margin-bottom: 20px; color: #ccc; font-size: 0.8em;">OKLARLA SE√á, 'ONAYLA'YA BAS</div>
            <button class="menu-btn" id="btnColorConfirm" onclick="confirmColorSelection()">KALKI≈û ONAYI</button>
        </div>

        <!-- HAZIRLIK -->
        <div id="startScreen" class="screen hidden">
            <h1 id="readyTitle">HAZIR?</h1>
            <div class="legend" style="display:flex; gap:20px; margin-bottom:20px; flex-wrap:wrap; justify-content:center;">
                <div style="color:#00ffff;">üõ°Ô∏è Kalkan</div>
                <div style="color:#ffff00;">‚è≥ Yava≈ülat</div>
            </div>
            <p id="modeHint" style="color:#aaa; font-size:1rem; margin-bottom:20px; font-family: 'Courier New';"></p>
            <button class="menu-btn selected" id="startBtn">MOTORLARI √áALI≈ûTIR</button>
        </div>

        <!-- OYUN SONU -->
        <div id="gameOverScreen" class="screen hidden">
            <h1 style="color: #ff3333;">G√ñREV BA≈ûARISIZ</h1>
            <table class="winner-table" id="scoreTable"></table>
            <button class="menu-btn selected" id="restartBtn">√úSSE D√ñN</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const bgCanvas = document.getElementById('bgCanvas');
        const bgCtx = bgCanvas.getContext('2d');
        const gameContainer = document.getElementById('gameContainer');
        
        // UI Referanslarƒ±
        const modeScreen = document.getElementById('modeScreen');
        const colorScreen = document.getElementById('colorScreen');
        const startScreen = document.getElementById('startScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const p1ScoreEl = document.getElementById('p1Score');
        const p1ComboEl = document.getElementById('p1Combo');
        const p2ScoreEl = document.getElementById('p2Score');
        const p2ComboEl = document.getElementById('p2Combo');
        const p2Stats = document.getElementById('p2Stats');
        const livesDisplay = document.getElementById('livesDisplay');
        const scoreTable = document.getElementById('scoreTable');
        const pauseBtn = document.getElementById('pauseBtn');
        const pauseOverlay = document.getElementById('pauseOverlay');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const homeBtn = document.getElementById('homeBtn');
        const divider = document.getElementById('divider');
        const gamepadStatus = document.getElementById('gamepadStatus');
        const controlsWrapper = document.getElementById('controlsWrapper');
        const rightControls = document.getElementById('rightControls');
        const btnColorConfirm = document.getElementById('btnColorConfirm');

        let gameMode = 1; 
        let currentPlayerSelecting = 1;
        let isPlaying = false; isPaused = false;
        let lives = 3;
        let speed = 5; let baseSpeed = 5;
        let animationId; let frames = 0;
        let isPseudoFullscreen = false; let isPortrait = false;
        let shakeIntensity = 0; let globalSlowMo = 1.0; let slowMoTimer = 0;

        let menuIndex = 0; let selectedColorIndex = 0; let lastGamepadInputTime = 0; 

        const colors = ['#00ffff', '#ff00ff', '#00ff00', '#ffff00', '#ff3300', '#aa00ff', '#ffffff', '#0099ff'];
        const playerSize = 50; 
        
        // Oyuncu Nesneleri (Active default false)
        const player1 = { x: 0, y: 0, color: '#00ffff', trail: [], lastShot: 0, shieldTimer: 0, invulnerable: 0, score: 0, combo: 1, active: true };
        const player2 = { x: 0, y: 0, color: '#ff00ff', trail: [], lastShot: 0, shieldTimer: 0, invulnerable: 0, score: 0, combo: 1, active: false };

        let obstacles = []; let particles = []; let bullets = []; let powerups = []; let backgroundStars = []; let floatingTexts = [];

        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);

            if (type === 'hurt') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, t); osc.frequency.exponentialRampToValueAtTime(50, t + 0.4);
                gain.gain.setValueAtTime(0.3, t); gain.gain.exponentialRampToValueAtTime(0.001, t + 0.4); osc.start(t); osc.stop(t + 0.4);
            } else if (type === 'click' || type === 'menu_move') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(600, t); gain.gain.setValueAtTime(0.1, t); gain.gain.exponentialRampToValueAtTime(0.001, t + 0.1); osc.start(t); osc.stop(t + 0.1);
            } else if (type === 'select') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(400, t); osc.frequency.linearRampToValueAtTime(800, t+0.1); gain.gain.setValueAtTime(0.1, t); gain.gain.exponentialRampToValueAtTime(0.001, t + 0.1); osc.start(t); osc.stop(t + 0.1);
            } else if (type === 'shoot') {
                osc.type = 'square'; osc.frequency.setValueAtTime(880, t); osc.frequency.exponentialRampToValueAtTime(200, t + 0.15); gain.gain.setValueAtTime(0.05, t); gain.gain.exponentialRampToValueAtTime(0.01, t + 0.15); osc.start(t); osc.stop(t + 0.15);
            } else if (type === 'explosion') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, t); osc.frequency.exponentialRampToValueAtTime(10, t + 0.3); gain.gain.setValueAtTime(0.2, t); gain.gain.exponentialRampToValueAtTime(0.001, t + 0.3); osc.start(t); osc.stop(t + 0.3);
            } else if (type === 'powerup') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(600, t); osc.frequency.linearRampToValueAtTime(1200, t+0.2); gain.gain.setValueAtTime(0.1, t); gain.gain.exponentialRampToValueAtTime(0.001, t + 0.2); osc.start(t); osc.stop(t + 0.2);
            } else if (type === 'combo') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(800 + (Math.max(player1.combo, player2.combo)*50), t); gain.gain.setValueAtTime(0.05, t); gain.gain.exponentialRampToValueAtTime(0.001, t + 0.1); osc.start(t); osc.stop(t + 0.1);
            } else if (type === 'armor') {
                osc.type = 'square'; osc.frequency.setValueAtTime(200, t); gain.gain.setValueAtTime(0.1, t); gain.gain.exponentialRampToValueAtTime(0.001, t + 0.05); osc.start(t); osc.stop(t + 0.05);
            }
        }

        function initStars() {
            backgroundStars = [];
            for(let i=0; i<80; i++) {
                backgroundStars.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, size: Math.random() * 2, speed: Math.random() * 3 + 1 });
            }
        }

        function drawBackground() {
            bgCtx.fillStyle = '#050505'; bgCtx.fillRect(0, 0, canvas.width, canvas.height);
            bgCtx.strokeStyle = 'rgba(0, 255, 255, 0.05)'; bgCtx.lineWidth = 1; bgCtx.beginPath();
            for(let i=0; i<canvas.width; i+=50) { bgCtx.moveTo(i, 0); bgCtx.lineTo(i, canvas.height); }
            for(let i=(Date.now()/20)%50; i<canvas.height; i+=50) { bgCtx.moveTo(0, i); bgCtx.lineTo(canvas.width, i); }
            bgCtx.stroke();
            bgCtx.fillStyle = '#fff';
            backgroundStars.forEach(star => {
                if (isPlaying && !isPaused) star.y += star.speed * globalSlowMo;
                if (star.y > canvas.height) { star.y = 0; star.x = Math.random() * canvas.width; }
                bgCtx.globalAlpha = Math.random() * 0.5 + 0.3; bgCtx.fillRect(star.x, star.y, star.size, star.size);
            });
            bgCtx.globalAlpha = 1.0;
        }

        function triggerShake(intensity) { shakeIntensity = intensity; }

        // --- YENƒ∞ G√ú√áL√ú U√áAK √áƒ∞Zƒ∞Mƒ∞ (KOD ƒ∞LE) ---
        function drawRealisticPlane(ctx, p) {
            const x = p.x; const y = p.y; const s = playerSize;
            ctx.save();
            ctx.translate(x + s/2, y + s/2);
            
            // Ana G√∂vde (Keskin Jet ≈ûekli)
            ctx.fillStyle = p.color;
            ctx.shadowBlur = 15; ctx.shadowColor = p.color;
            ctx.beginPath();
            ctx.moveTo(0, -s/2); // Burun
            ctx.lineTo(s/6, -s/6); // Kokpit yanƒ±
            ctx.lineTo(s/2, s/4); // Kanat ucu
            ctx.lineTo(s/6, s/4); // Kanat arkasƒ±
            ctx.lineTo(s/6, s/2); // Kuyruk
            ctx.lineTo(-s/6, s/2);
            ctx.lineTo(-s/6, s/4);
            ctx.lineTo(-s/2, s/4);
            ctx.lineTo(-s/6, -s/6);
            ctx.closePath();
            ctx.fill();

            // Kokpit Camƒ±
            ctx.fillStyle = "#fff";
            ctx.shadowBlur = 5; ctx.shadowColor = "#fff";
            ctx.beginPath();
            ctx.moveTo(0, -s/4);
            ctx.lineTo(s/10, 0);
            ctx.lineTo(0, s/10);
            ctx.lineTo(-s/10, 0);
            ctx.closePath();
            ctx.fill();

            // Motor Alevleri
            if(Math.random() > 0.3) {
                ctx.fillStyle = '#ffaa00'; ctx.shadowColor = '#ff4400'; ctx.shadowBlur = 10;
                ctx.beginPath(); ctx.moveTo(-s/8, s/2); ctx.lineTo(s/8, s/2); ctx.lineTo(0, s/2 + Math.random()*20 + 10); ctx.fill();
            }
            ctx.restore();
        }

        function drawEnemyShip(ctx, o) {
            ctx.save();
            ctx.shadowBlur = 10;
            ctx.shadowColor = o.targetColor;
            ctx.strokeStyle = o.targetColor;
            ctx.fillStyle = o.armored ? '#555' : `${o.targetColor}40`; // Zƒ±rhlƒ± daha koyu
            ctx.lineWidth = 3;

            if (o.armored) {
                // Zƒ±rhlƒ± Kruvaz√∂r (Altƒ±gen)
                ctx.beginPath();
                ctx.moveTo(o.x + o.w/2, o.y); // √úst orta
                ctx.lineTo(o.x + o.w, o.y + o.h/3);
                ctx.lineTo(o.x + o.w, o.y + o.h);
                ctx.lineTo(o.x + o.w/2, o.y + o.h + 10); // Sivri alt
                ctx.lineTo(o.x, o.y + o.h);
                ctx.lineTo(o.x, o.y + o.h/3);
                ctx.closePath();
                ctx.fill(); ctx.stroke();
                // Detay
                ctx.fillStyle = "#000";
                ctx.fillRect(o.x + o.w/2 - 5, o.y + o.h/2 - 5, 10, 10);
            } else {
                // Normal D√º≈üman (Kare Kutu)
                ctx.fillRect(o.x, o.y, o.w, o.h);
                ctx.strokeRect(o.x, o.y, o.w, o.h);
                // ƒ∞√ß √ßekirdek
                ctx.fillStyle = '#fff';
                ctx.fillRect(o.x + o.w/2 - 5, o.y + o.h/2 - 5, 10, 10);
            }
            ctx.restore();
        }

        function takeDamage(p) {
            if (p.invulnerable > 0) return;
            lives--;
            p.score -= 50; if(p.score < 0) p.score = 0;
            p.combo = 1; 
            updateScoreUI(); updateLivesUI();
            playSound('hurt'); triggerShake(20);
            floatingTexts.push({ text: "-50", x: p.x, y: p.y - 20, color: "#ff0000", life: 1.0 });
            createParticles(p.x + playerSize/2, p.y + playerSize/2, '#ff0000');
            if (lives <= 0) { gameOver(); } 
            else { player1.invulnerable = 120; player2.invulnerable = 120; }
        }

        function addScore(p, amount) { p.score += amount; updateScoreUI(); }
        function incrementCombo(p) { p.combo++; addScore(p, 10 * p.combo); if (p.combo > 1) playSound('combo'); updateScoreUI(); }

        function updateScoreUI() {
            p1ScoreEl.innerText = player1.score; p2ScoreEl.innerText = player2.score;
            if (player1.combo > 1) { p1ComboEl.innerText = `x${player1.combo}`; p1ComboEl.style.opacity = 1; } else p1ComboEl.style.opacity = 0;
            if (player2.combo > 1) { p2ComboEl.innerText = `x${player2.combo}`; p2ComboEl.style.opacity = 1; } else p2ComboEl.style.opacity = 0;
        }
        function updateLivesUI() {
            let hearts = ""; for(let i=0; i<lives; i++) hearts += "‚ù§Ô∏è"; livesDisplay.innerText = hearts;
        }

        // ... Men√º Fonksiyonlarƒ± ...
        function selectMode(mode) { gameMode = mode; modeScreen.classList.add('hidden'); currentPlayerSelecting = 1; selectedColorIndex = 0; setupColorSelection(1); playSound('select'); }
        
        function setupColorSelection(playerNum) {
            currentPlayerSelecting = playerNum; colorScreen.classList.remove('hidden');
            const grid = document.getElementById('colorGrid'); grid.innerHTML = '';
            document.getElementById('colorTitle').innerText = (gameMode === 1 || isPortrait) ? "U√ßak Rengi Se√ß" : `P${playerNum} U√ßak Rengi`;
            btnColorConfirm.innerText = (gameMode === 2 && !isPortrait && playerNum === 1) ? "ONAYLA & SONRAKƒ∞ Pƒ∞LOT" : "ONAYLA & KALKI≈û YAP";
            colors.forEach((c, index) => {
                const btn = document.createElement('div'); btn.className = 'color-btn'; btn.style.backgroundColor = c; btn.innerText = index + 1;
                const isTaken = (gameMode === 2 && !isPortrait && playerNum === 2 && player1.color === c);
                if (isTaken) btn.classList.add('color-taken');
                btn.onclick = () => { if(isTaken) return; selectedColorIndex = index; updateColorGridVisuals(); playSound('click'); };
                grid.appendChild(btn);
            });
            updateColorGridVisuals();
        }
        function updateColorGridVisuals() {
            const btns = document.querySelectorAll('.color-btn');
            btns.forEach((btn, idx) => { if (idx === selectedColorIndex) btn.classList.add('focused'); else btn.classList.remove('focused'); });
            btnColorConfirm.style.borderColor = colors[selectedColorIndex]; btnColorConfirm.style.color = colors[selectedColorIndex];
        }
        function confirmColorSelection() {
            const chosenColor = colors[selectedColorIndex];
            if (gameMode === 2 && !isPortrait && currentPlayerSelecting === 2 && player1.color === chosenColor) return;
            playSound('select');
            if (gameMode === 1 || isPortrait) { player1.color = chosenColor; player2.color = chosenColor; finishSetup(); } 
            else { if (currentPlayerSelecting === 1) { player1.color = chosenColor; currentPlayerSelecting = 2; let nextIdx = 0; while(colors[nextIdx] === player1.color) nextIdx++; selectedColorIndex = nextIdx; setupColorSelection(2); } else { player2.color = chosenColor; finishSetup(); } }
        }
        function finishSetup() {
            colorScreen.classList.add('hidden'); updateUIColors();
            if (isPortrait) document.getElementById('modeHint').innerHTML = "Dƒ∞KEY MOD<br>Tek Kontrolc√º - T√ºm Gemileri Y√∂net";
            else if (gameMode === 1) document.getElementById('modeHint').innerText = "1 OYUNCU: Tek U√ßak, √áift Kontrol";
            else modeHint.innerText = "2 OYUNCU: Herkes Kendi Tarafƒ±nƒ± Korur!";
            
            if (gameMode === 2 && !isPortrait) { p2Stats.style.display = 'block'; player2.active = true; } 
            else { p2Stats.style.display = 'none'; player2.active = false; }
            startScreen.classList.remove('hidden');
        }
        function updateUIColors() {
            const cL = player1.color; const cR = (gameMode === 1 || isPortrait) ? player1.color : player2.color;
            document.querySelector('#readyTitle').style.background = `linear-gradient(90deg, ${cL}, ${cR})`;
            document.querySelector('#readyTitle').style.webkitTextFillColor = 'transparent';
            document.querySelector('#readyTitle').style.webkitBackgroundClip = 'text';
            document.getElementById('p1Stats').style.color = player1.color; document.getElementById('p2Stats').style.color = player2.color;
        }
        function resetToMenu() {
            isPlaying = false; isPaused = false; pauseOverlay.style.display = 'none';
            gameOverScreen.classList.add('hidden'); startScreen.classList.add('hidden'); colorScreen.classList.add('hidden'); modeScreen.classList.remove('hidden'); divider.style.opacity = '1';
            if(isPseudoFullscreen) { gameContainer.classList.remove('pseudo-fullscreen'); isPseudoFullscreen = false; gameContainer.style.cursor = 'default'; resizeCanvas(); }
        }

        const keys = { z: false, c: false, x: false, ArrowLeft: false, ArrowRight: false, ArrowDown: false };
        document.getElementById('startBtn').addEventListener('click', startGame);
        document.getElementById('restartBtn').addEventListener('click', resetToMenu);
        document.getElementById('homeBtn').addEventListener('click', resetToMenu);

        function startGame() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            isPlaying = true; isPaused = false; pauseBtn.innerText = '‚ùö‚ùö'; pauseOverlay.style.display = 'none';
            score = 0; combo = 1; maxCombo = 1; speed = 5; frames = 0; lives = 3;
            shakeIntensity = 0; globalSlowMo = 1.0;
            player1.score = 0; player1.combo = 1; player1.shieldTimer = 0; player1.invulnerable = 0;
            player2.score = 0; player2.combo = 1; player2.shieldTimer = 0; player2.invulnerable = 0;
            obstacles = []; particles = []; bullets = []; powerups = []; floatingTexts = [];
            
            // Canvas'ƒ± hazƒ±rla
            resizeCanvas();
            
            // OYUNCULARI KONUMLANDIR VE AKTƒ∞F ET (KESƒ∞N D√úZELTME)
            if (gameMode === 2 && !isPortrait) {
                // 2 Ki≈üilik Mod: Ayrƒ± Konumlar, ƒ∞kisi de Aktif
                player1.x = (canvas.width * 0.25) - (playerSize / 2);
                player2.x = (canvas.width * 0.75) - (playerSize / 2);
                player1.active = true; 
                player2.active = true;
            } else {
                // 1 Ki≈üilik Mod: Ortada, Sadece P1 Aktif
                player1.x = (canvas.width * 0.5) - (playerSize / 2);
                player1.active = true; 
                player2.active = false;
            }
            
            // Y√ºksekliƒüi Ayarla (Kontrol panelinin hemen √ºst√º)
            const controlsH = document.getElementById('controlsWrapper').offsetHeight || 120;
            const targetY = canvas.height - controlsH - playerSize - 20;
            player1.y = targetY;
            player2.y = targetY;

            startScreen.classList.add('hidden'); gameOverScreen.classList.add('hidden');
            updateScoreUI(); updateLivesUI();
        }

        function spawnPowerup() {
            const type = Math.random() > 0.5 ? 'shield' : 'slow';
            const size = 30; const x = Math.random() * (canvas.width - size);
            powerups.push({ x: x, y: -50, w: size, h: size, type: type, speed: baseSpeed * 0.8, color: type === 'shield' ? '#00ffff' : '#ffff00' });
        }

        function gameLoop() {
            requestAnimationFrame(gameLoop);
            const gp = pollGamepads();
            if (!isPlaying || isPaused) {
                if (gp) {
                    let dir = null;
                    if (gp.left) dir = 'left'; if (gp.right) dir = 'right'; if (gp.up) dir = 'up'; if (gp.down) dir = 'down';
                    if (dir || gp.fire) handleMenuInput(dir, gp.fire); else lastGamepadInputTime = 0;
                }
                return;
            }
            update(gp); draw();
        }

        window.addEventListener("gamepadconnected", () => { document.getElementById('gamepadStatus').style.display = 'block'; setTimeout(() => document.getElementById('gamepadStatus').style.display = 'none', 3000); });
        function pollGamepads() { const gp = navigator.getGamepads ? navigator.getGamepads()[0] : null; if(!gp) return null; const dead=0.5; return { left: gp.axes[0]<-dead||gp.buttons[14]?.pressed, right: gp.axes[0]>dead||gp.buttons[15]?.pressed, up: gp.axes[1]<-dead||gp.buttons[12]?.pressed, down: gp.axes[1]>dead||gp.buttons[13]?.pressed, fire: gp.buttons[0]?.pressed||gp.buttons[1]?.pressed }; }

        function update(gp) {
            if (slowMoTimer > 0) { globalSlowMo = 0.4; slowMoTimer--; } else { globalSlowMo = 1.0; }
            if (player1.shieldTimer > 0) player1.shieldTimer--; if (player2.shieldTimer > 0) player2.shieldTimer--;
            if (player1.invulnerable > 0) player1.invulnerable--; if (player2.invulnerable > 0) player2.invulnerable--;

            const gpInput = gp || { left: false, right: false, fire: false };
            const moveSpeed = ((canvas.width < 600) ? 6 : 9) * (globalSlowMo < 1 ? 0.8 : 1); 

            const p1L = keys.z || gpInput.left || (gameMode===1 && keys.ArrowLeft);
            const p1R = keys.c || gpInput.right || (gameMode===1 && keys.ArrowRight);
            const p1F = keys.x || gpInput.fire || (gameMode===1 && keys.ArrowDown);
            const p2L = keys.ArrowLeft; const p2R = keys.ArrowRight; const p2F = keys.ArrowDown;

            if (gameMode === 1 || isPortrait) {
                if (p1L && player1.x > 0) player1.x -= moveSpeed;
                if (p1R && player1.x < canvas.width - playerSize) player1.x += moveSpeed;
                if (p1F) fireBullet(player1, player1.x);
                if (frames % 3 === 0) { player1.trail.push({x: player1.x, y: player1.y}); if(player1.trail.length > 8) player1.trail.shift(); }
            } else {
                if (p1L && player1.x > 0) player1.x -= moveSpeed;
                if (p1R && player1.x < (canvas.width/2) - playerSize - 5) player1.x += moveSpeed;
                if (p1F) fireBullet(player1, player1.x);
                if (p2L && player2.x > (canvas.width/2) + 5) player2.x -= moveSpeed;
                if (p2R && player2.x < canvas.width - playerSize) player2.x += moveSpeed;
                if (p2F) fireBullet(player2, player2.x);
                if (frames % 3 === 0) { player1.trail.push({x: player1.x, y: player1.y}); player2.trail.push({x: player2.x, y: player2.y}); if(player1.trail.length > 8) player1.trail.shift(); if(player2.trail.length > 8) player2.trail.shift(); }
            }

            for(let i=bullets.length-1; i>=0; i--) { bullets[i].y -= 12 * globalSlowMo; if(bullets[i].y < 0) bullets.splice(i,1); }
            for(let i=floatingTexts.length-1; i>=0; i--) { let ft = floatingTexts[i]; ft.y -= 1; ft.life -= 0.02; if (ft.life <= 0) floatingTexts.splice(i, 1); }
            
            for(let i=powerups.length-1; i>=0; i--) {
                let p = powerups[i]; p.y += p.speed * globalSlowMo;
                let players = (gameMode === 1 || isPortrait) ? [player1] : (p.x < canvas.width/2 ? [player1] : [player2]);
                for(let ply of players) {
                    if(!ply.active) continue;
                    if (ply.x < p.x + p.w && ply.x + playerSize > p.x && ply.y < p.y + p.h && ply.y + playerSize > p.y) {
                        playSound('powerup'); if (p.type === 'shield') ply.shieldTimer = 300; else slowMoTimer = 300; powerups.splice(i, 1); return;
                    }
                }
                if (p.y > canvas.height) powerups.splice(i, 1);
            }

            let spawnRate = Math.max(20, 60 - Math.floor((player1.score+player2.score)/100));
            if (frames % spawnRate === 0) {
                if (Math.random() < 0.05) spawnPowerup();
                const type = Math.random(); const obsSize = 40; const isArmored = Math.random() < 0.25; 
                if (gameMode === 1 || isPortrait) obstacles.push({ x: Math.random() * (canvas.width - obsSize), y: -50, w: obsSize, h: obsSize, speed: speed + Math.random(), armored: isArmored, targetColor: player1.color, side: 'all' });
                else {
                    if (type < 0.6) obstacles.push({ side: 'left', x: Math.random()*((canvas.width/2)-obsSize), y: -50, w: obsSize, h: obsSize, speed: speed+Math.random(), armored: isArmored, targetColor: player1.color });
                    if (type > 0.4) obstacles.push({ side: 'right', x: (canvas.width/2) + Math.random()*((canvas.width/2)-obsSize), y: -50, w: obsSize, h: obsSize, speed: speed+Math.random(), armored: isArmored, targetColor: player2.color });
                }
            }

            for (let i = obstacles.length - 1; i >= 0; i--) {
                let obs = obstacles[i]; obs.y += obs.speed * globalSlowMo; let hit = false;
                for (let j = bullets.length - 1; j >= 0; j--) {
                    let b = bullets[j];
                    let canHit = (gameMode === 1 || isPortrait) || (b.side === obs.side);
                    if (canHit && b.x > obs.x && b.x < obs.x+obs.w && b.y > obs.y && b.y < obs.y+obs.h) {
                        bullets.splice(j, 1);
                        let shooter = (gameMode === 1 || isPortrait) ? player1 : (b.side === 'left' ? player1 : player2);
                        if (obs.armored) { playSound('armor'); createParticles(b.x, b.y, '#fff'); shooter.combo=1; updateScoreUI(); }
                        else { createParticles(obs.x+obs.w/2, obs.y+obs.h/2, obs.targetColor); triggerShake(5); obstacles.splice(i, 1); hit = true; incrementCombo(shooter); }
                        break;
                    }
                }
                if (hit) continue;

                let players = (gameMode === 1 || isPortrait) ? [player1] : (obs.side === 'left' ? [player1] : [player2]);
                for (let p of players) {
                    if (!p.active) continue;
                    // √áARPI≈ûMA ALANI (ƒ∞yile≈ütirildi)
                    if (p.x + 10 < obs.x + obs.w && p.x + playerSize - 10 > obs.x && p.y + 15 < obs.y + obs.h && p.y + playerSize - 10 > obs.y) {
                        if (p.shieldTimer > 0) { obstacles.splice(i, 1); createParticles(obs.x, obs.y, '#fff'); playSound('explosion'); triggerShake(10); return; }
                        else { takeDamage(p); obstacles.splice(i, 1); return; }
                    }
                }
                if (obs.y > canvas.height) {
                    obstacles.splice(i, 1); 
                    let owner = (gameMode === 1 || isPortrait) ? player1 : (obs.side === 'left' ? player1 : player2);
                    if(!obs.armored){ owner.combo=1; updateScoreUI(); } else { addScore(owner, 5 * owner.combo); }
                }
            }
            for(let i=particles.length-1; i>=0; i--) { particles[i].x += particles[i].vx; particles[i].y += particles[i].vy; particles[i].life -= 0.05; if(particles[i].life <= 0) particles.splice(i, 1); }
            frames++;
        }

        function fireBullet(p, x) {
            if (Date.now() - p.lastShot > 200) { // Hƒ±zlandƒ±rƒ±ldƒ±
                p.lastShot = Date.now();
                bullets.push({ x: x + playerSize/2, y: p.y, r: 4, color: p.color, side: (gameMode===2 && !isPortrait && p===player1)?'left':((gameMode===2 && !isPortrait)?'right':'all') });
                playSound('shoot');
            }
        }

        function draw() {
            if (shakeIntensity > 0) {
                let dx = (Math.random() - 0.5) * shakeIntensity; let dy = (Math.random() - 0.5) * shakeIntensity;
                ctx.setTransform(1, 0, 0, 1, dx, dy); shakeIntensity *= 0.9; if (shakeIntensity < 0.5) shakeIntensity = 0;
            } else ctx.setTransform(1, 0, 0, 1, 0, 0);

            drawBackground(); ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            floatingTexts.forEach(ft => { ctx.globalAlpha = ft.life; ctx.fillStyle = ft.color; ctx.font = "bold 20px Courier New"; ctx.fillText(ft.text, ft.x, ft.y); });
            ctx.globalAlpha = 1.0;

            powerups.forEach(p => {
                ctx.shadowBlur=20; ctx.shadowColor=p.color; ctx.fillStyle=p.color; ctx.beginPath();
                if (p.type === 'shield') ctx.arc(p.x+p.w/2, p.y+p.h/2, p.w/2, 0, Math.PI*2); else ctx.fillRect(p.x, p.y, p.w, p.h);
                ctx.fill(); ctx.fillStyle='#000'; ctx.font='bold 16px Arial'; ctx.textAlign='center'; ctx.fillText(p.type==='shield'?'S':'T', p.x+p.w/2, p.y+p.h/1.5);
            });

            // OYUNCULARI √áƒ∞Z
            let players = [];
            if (player1.active) players.push(player1);
            if (player2.active) players.push(player2);

            players.forEach(p => {
                if(p.invulnerable > 0 && Math.floor(Date.now() / 100) % 2 === 0) return;
                drawRealisticPlane(ctx, p); 
                if (p.shieldTimer > 0) { ctx.beginPath(); ctx.arc(p.x+playerSize/2, p.y+playerSize/2, playerSize, 0, Math.PI*2); ctx.strokeStyle=`rgba(255,255,255,${Math.random()*0.5+0.5})`; ctx.lineWidth=3; ctx.stroke(); }
                ctx.shadowBlur=0; ctx.lineWidth=2; ctx.strokeStyle=p.color; ctx.beginPath(); p.trail.forEach((t,i)=>{ if(i===0)ctx.moveTo(t.x+15,t.y+15);else ctx.lineTo(t.x+15,t.y+15); }); ctx.stroke();
            });

            ctx.shadowBlur=10; bullets.forEach(b => { ctx.fillStyle=b.color; ctx.shadowColor=b.color; ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI*2); ctx.fill(); });
            obstacles.forEach(o => { drawEnemyShip(ctx, o); });
            ctx.shadowBlur=0; particles.forEach(p => { ctx.globalAlpha=p.life; ctx.fillStyle=p.color; ctx.fillRect(p.x, p.y, 4, 4); }); ctx.globalAlpha=1.0;
        }
        
        function createParticles(x,y,c) { for(let i=0;i<12;i++) particles.push({x, y, vx:(Math.random()-0.5)*12, vy:(Math.random()-0.5)*12, life:1, color:c}); }
        function shadeColor(color, percent) { return color; }
        function gameOver() { 
            isPlaying = false; 
            let html = "";
            if (gameMode === 1 || isPortrait) {
                html = `<tr><td>SKOR</td><td class="winner-row">${player1.score}</td></tr>`;
            } else {
                let winner = player1.score > player2.score ? "1. Pƒ∞LOT KAZANDI!" : (player2.score > player1.score ? "2. Pƒ∞LOT KAZANDI!" : "BERABERE!");
                let color = player1.score > player2.score ? player1.color : (player2.score > player1.score ? player2.color : "#fff");
                html += `<tr><td colspan="2" style="color:${color}; font-size:1.5em; padding-bottom:20px;">${winner}</td></tr>`;
                html += `<tr><td style="color:${player1.color}">P1 SKOR</td><td style="color:${player1.color}">${player1.score}</td></tr>`;
                html += `<tr><td style="color:${player2.color}">P2 SKOR</td><td style="color:${player2.color}">${player2.score}</td></tr>`;
            }
            scoreTable.innerHTML = html;
            gameOverScreen.classList.remove('hidden'); 
        }

        function resizeCanvas() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            bgCanvas.width = window.innerWidth; bgCanvas.height = window.innerHeight;
            isPortrait = window.innerHeight > window.innerWidth;
            const controlHeight = 120; // Sabit kontrol alanƒ±
            const targetY = canvas.height - controlHeight - playerSize - 20; 
            player1.y = targetY; player2.y = targetY;
            if (isPortrait) { controlsWrapper.classList.add('portrait-mode-controls'); rightControls.classList.add('hidden'); divider.style.opacity = '0'; } 
            else { controlsWrapper.classList.remove('portrait-mode-controls'); if (gameMode === 2) { rightControls.classList.remove('hidden'); divider.style.opacity = '1'; } else { rightControls.classList.remove('hidden'); divider.style.opacity = '0'; } }
            
            // Pozisyon d√ºzeltme (Oyun sƒ±rasƒ±nda deƒüilse)
            if (!isPlaying) {
                if (gameMode === 2 && !isPortrait) { player1.x = (canvas.width * 0.25) - (playerSize/2); player2.x = (canvas.width * 0.75) - (playerSize/2); } 
                else { player1.x = (canvas.width * 0.5) - (playerSize/2); }
            }
        }
        window.addEventListener('resize', resizeCanvas); resizeCanvas(); initStars();

        const toggleFullscreen = () => {
            if (document.fullscreenElement) { document.exitFullscreen(); return; }
            if (isPseudoFullscreen) { gameContainer.classList.remove('pseudo-fullscreen'); isPseudoFullscreen = false; gameContainer.style.cursor = 'default'; resizeCanvas(); return; }
            const req = gameContainer.requestFullscreen || gameContainer.webkitRequestFullscreen || gameContainer.msRequestFullscreen;
            if (req) { req.call(gameContainer).catch(() => { gameContainer.classList.add('pseudo-fullscreen'); isPseudoFullscreen = true; gameContainer.style.cursor = 'none'; resizeCanvas(); }); } 
            else { gameContainer.classList.add('pseudo-fullscreen'); isPseudoFullscreen = true; gameContainer.style.cursor = 'none'; resizeCanvas(); }
        };
        fullscreenBtn.addEventListener('click', toggleFullscreen);

        function togglePause() {
            if (!isPlaying) return;
            isPaused = !isPaused; pauseBtn.innerText = isPaused ? '‚ñ∂' : '‚ùö‚ùö';
            pauseOverlay.style.display = isPaused ? 'block' : 'none';
            if(!isPaused && audioCtx.state === 'suspended') audioCtx.resume();
        }
        pauseBtn.addEventListener('click', togglePause);

        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && isPseudoFullscreen) toggleFullscreen();
            if (!isPlaying || isPaused) {
                if (e.key === 'ArrowUp') handleMenuInput('up', false);
                else if (e.key === 'ArrowDown') handleMenuInput('down', false);
                else if (e.key === 'ArrowLeft') handleMenuInput('left', false);
                else if (e.key === 'ArrowRight') handleMenuInput('right', false);
                else if (e.key === 'Enter') handleMenuInput(null, true);
                else if (e.key >= '1' && e.key <= '8' && !colorScreen.classList.contains('hidden')) {
                    const idx = parseInt(e.key) - 1; if(idx < colors.length) { selectedColorIndex = idx; updateColorGridVisuals(); }
                }
                return;
            }
            if ((e.key.toLowerCase() === 's' || e.key === 'ArrowUp') && isPlaying) { togglePause(); return; }
            if (e.key.toLowerCase() === 'z') keys.z = true; if (e.key.toLowerCase() === 'c') keys.c = true; if (e.key.toLowerCase() === 'x') keys.x = true;
            if (e.key === 'ArrowLeft') keys.ArrowLeft = true; if (e.key === 'ArrowRight') keys.ArrowRight = true; if (e.key === 'ArrowDown') keys.ArrowDown = true;
        });
        window.addEventListener('keyup', (e) => {
            if (e.key.toLowerCase() === 'z') keys.z = false; if (e.key.toLowerCase() === 'c') keys.c = false; if (e.key.toLowerCase() === 'x') keys.x = false;
            if (e.key === 'ArrowLeft') keys.ArrowLeft = false; if (e.key === 'ArrowRight') keys.ArrowRight = false; if (e.key === 'ArrowDown') keys.ArrowDown = false;
        });

        document.querySelectorAll('.btn').forEach(btn => {
            const k = btn.dataset.key;
            btn.addEventListener('touchstart', (e)=>{ e.preventDefault(); keys[k]=true; btn.classList.add('active'); if(isPlaying) playSound('click'); });
            btn.addEventListener('touchend', (e)=>{ e.preventDefault(); keys[k]=false; btn.classList.remove('active'); });
            btn.addEventListener('mousedown', ()=>{ keys[k]=true; btn.classList.add('active'); if(isPlaying) playSound('click'); });
            btn.addEventListener('mouseup', ()=>{ keys[k]=false; btn.classList.remove('active'); });
        });

        requestAnimationFrame(gameLoop);
    </script>
</body>
</html>


