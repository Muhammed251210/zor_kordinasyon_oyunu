<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>N√∂ro Senkron - Final Fix</title>
    <style>
        /* GENEL AYARLAR */
        html, body {
            margin: 0; padding: 0;
            background-color: #000; color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden; height: 100%; width: 100%;
            touch-action: none; user-select: none;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }

        #gameContainer {
            position: relative; width: 100%; height: 100%;
            background: #000;
        }

        /* Sahte Tam Ekran */
        .pseudo-fullscreen {
            position: fixed !important; top: 0; left: 0; right: 0; bottom: 0;
            width: 100vw !important; height: 100vh !important;
            z-index: 99999; background: #000; margin: 0; padding: 0;
        }

        canvas {
            display: block; background: #111; width: 100%; height: 100%;
            object-fit: contain; box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        /* UI ELEMENTLERƒ∞ */
        #uiLayer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; align-items: center;
            z-index: 10;
        }

        #scoreDisplay {
            font-size: 5vh; font-weight: 900; margin-top: 20px;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
        }

        #gamepadStatus {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 255, 0, 0.2); border: 1px solid #00ff00; color: #00ff00;
            padding: 8px 15px; border-radius: 20px; font-weight: bold; font-size: 0.8rem;
            display: none; animation: fadeIn 0.5s; z-index: 60; backdrop-filter: blur(2px);
        }

        #fullscreenBtn, #pauseBtn {
            position: absolute; top: 20px;
            background: rgba(255, 255, 255, 0.15); border: 2px solid rgba(255, 255, 255, 0.4);
            color: white; border-radius: 12px; cursor: pointer; z-index: 50;
            display: flex; justify-content: center; align-items: center;
            pointer-events: auto; transition: all 0.2s; backdrop-filter: blur(4px);
        }
        #fullscreenBtn { right: 20px; width: 50px; height: 50px; font-size: 24px; }
        #pauseBtn { left: 20px; width: 50px; height: 50px; font-size: 24px; }
        #fullscreenBtn:hover, #pauseBtn:hover { background: rgba(255, 255, 255, 0.4); transform: scale(1.1); }

        /* MEN√úLER */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            pointer-events: auto; backdrop-filter: blur(8px); z-index: 40; text-align: center;
        }

        h1 {
            font-size: clamp(2rem, 5vw, 4rem); margin: 0 0 20px 0;
            background: linear-gradient(90deg, #fff, #aaa);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-transform: uppercase; letter-spacing: 2px;
        }

        .menu-btn {
            padding: 15px 40px; font-size: 1.2rem; background: transparent;
            color: #fff; border: 3px solid #fff; border-radius: 50px;
            cursor: pointer; font-weight: bold; margin: 10px; transition: all 0.2s;
            min-width: 250px; position: relative;
        }
        .menu-btn:hover, .menu-btn.selected {
            background: #fff; color: #000; transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255,255,255,0.6);
        }
        
        /* RENK SE√áƒ∞Mƒ∞ */
        .color-grid {
            display: flex; justify-content: center; gap: 20px; margin-top: 30px;
            flex-wrap: wrap; max-width: 800px;
        }
        .color-btn {
            width: 70px; height: 70px; border-radius: 50%; border: 5px solid transparent;
            cursor: pointer; transition: transform 0.2s; box-sizing: border-box;
            display: flex; justify-content: center; align-items: center;
            font-size: 20px; font-weight: bold; color: rgba(0,0,0,0.5);
        }
        .color-btn.focused { transform: scale(1.3); border-color: #fff; box-shadow: 0 0 30px rgba(255,255,255,0.9); z-index: 2; color: #000; }
        .color-taken { opacity: 0.2; filter: grayscale(100%); transform: scale(0.8); }

        /* KONTROLLER */
        #controlsWrapper {
            position: absolute; bottom: 0; left: 0; width: 100%;
            padding-bottom: 20px; pointer-events: none; z-index: 30;
            display: flex; justify-content: space-between; padding-left: 20px; padding-right: 20px; box-sizing: border-box;
        }

        .control-group { display: flex; gap: 10px; pointer-events: auto; align-items: flex-end; }
        
        .portrait-mode-controls {
            justify-content: center !important;
            width: 100%;
        }

        .btn {
            width: 70px; height: 70px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 18px;
            display: flex; justify-content: center; align-items: center;
            font-size: 28px; color: white;
            cursor: pointer; backdrop-filter: blur(4px);
            transition: background 0.1s; touch-action: none;
        }
        .btn:active, .btn.active { background: rgba(255, 255, 255, 0.4); transform: scale(0.95); }
        .btn-fire { border-width: 3px; font-weight: bold; }

        .hidden { display: none !important; }
        #divider {
            position: absolute; left: 50%; top: 0; bottom: 0; width: 2px;
            background: rgba(255,255,255,0.2); transform: translateX(-50%); transition: opacity 0.5s;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translate(-50%, -10px); } to { opacity: 1; transform: translate(-50%, 0); } }
        
        #pauseOverlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-size: 3rem; font-weight: bold; text-shadow: 0 0 20px cyan;
            pointer-events: none; z-index: 100; display: none;
        }
    </style>
</head>
<body>

    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="divider"></div>
        
        <div id="gamepadStatus">üéÆ GAMEPAD AKTƒ∞F</div>
        <div id="pauseOverlay">DURAKLATILDI</div>

        <button id="fullscreenBtn" title="Tam Ekran">‚õ∂</button>
        <button id="pauseBtn" title="Durdur">‚ùö‚ùö</button>
        
        <div id="uiLayer">
            <div id="scoreDisplay">0</div>
        </div>

        <!-- Kontrol Alanƒ± -->
        <div id="controlsWrapper">
            <!-- Sol / Tekli Kontrol -->
            <div class="control-group left-group" id="leftControls">
                <div class="btn" data-key="z">‚óÄ</div>
                <div class="btn btn-fire" data-key="x">‚óè</div> <!-- Ate≈ü -->
                <div class="btn" data-key="c">‚ñ∂</div>
            </div>

            <!-- Saƒü Kontrol -->
            <div class="control-group right-group" id="rightControls">
                <div class="btn" data-key="ArrowLeft">‚óÄ</div>
                <div class="btn btn-fire" data-key="ArrowDown">‚óè</div>
                <div class="btn" data-key="ArrowRight">‚ñ∂</div>
            </div>
        </div>

        <!-- EKRAN 1: MOD SE√áƒ∞Mƒ∞ -->
        <div id="modeScreen" class="screen">
            <h1>N√∂ro Senkron</h1>
            <button class="menu-btn selected" id="btnMode1" onclick="selectMode(1)">
                1 OYUNCU<br><span style="font-size:0.6em; opacity:0.8;">Tek Ekran</span>
            </button>
            <button class="menu-btn" id="btnMode2" onclick="selectMode(2)">
                2 OYUNCU<br><span style="font-size:0.6em; opacity:0.8;">B√∂l√ºnm√º≈ü Ekran</span>
            </button>
            <div style="margin-top:20px; color:#888; font-size:0.9em;">
                Gamepad: Y√∂n Tu≈ülarƒ± ile Se√ß, <b>X</b> ile Onayla
            </div>
        </div>

        <!-- EKRAN 2: RENK SE√áƒ∞Mƒ∞ -->
        <div id="colorScreen" class="screen hidden">
            <h1 id="colorTitle">Renk Se√ß</h1>
            <div class="color-grid" id="colorGrid"></div>
            <div style="margin-top: 40px; color: #ccc;">
                Tu≈ülar: 1-8 | Oklar | Gamepad
            </div>
        </div>

        <!-- EKRAN 3: HAZIRLIK -->
        <div id="startScreen" class="screen hidden">
            <h1 id="readyTitle">HAZIR MISIN?</h1>
            <p id="modeHint" style="color:#aaa; font-size:1.2rem; margin-bottom:20px;"></p>
            <button class="menu-btn selected" id="startBtn">BA≈ûLA</button>
        </div>

        <!-- EKRAN 4: OYUN SONU -->
        <div id="gameOverScreen" class="screen hidden">
            <h1 style="color: #ff3333;">OYUN Bƒ∞TTƒ∞</h1>
            <p style="font-size: 2rem;">Skor: <span id="finalScore" style="color: yellow;">0</span></p>
            <button class="menu-btn selected" id="restartBtn">ANA MEN√ú</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gameContainer = document.getElementById('gameContainer');
        
        // UI Referanslarƒ±
        const modeScreen = document.getElementById('modeScreen');
        const colorScreen = document.getElementById('colorScreen');
        const startScreen = document.getElementById('startScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const finalScoreEl = document.getElementById('finalScore');
        const pauseBtn = document.getElementById('pauseBtn');
        const pauseOverlay = document.getElementById('pauseOverlay');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const divider = document.getElementById('divider');
        const gamepadStatus = document.getElementById('gamepadStatus');
        const controlsWrapper = document.getElementById('controlsWrapper');
        const rightControls = document.getElementById('rightControls');

        // Oyun Durumu
        let gameMode = 1; 
        let currentPlayerSelecting = 1;
        let isPlaying = false;
        let isPaused = false;
        let score = 0;
        let speed = 5;
        let animationId;
        let frames = 0;
        let isPseudoFullscreen = false;
        let isPortrait = false;
        
        // Men√º Navigasyonu
        let menuIndex = 0; 
        let selectedColorIndex = 0;
        let lastGamepadInputTime = 0; 

        const colors = ['#00ffff', '#ff00ff', '#00ff00', '#ffff00', '#ff3300', '#aa00ff', '#ffffff', '#0099ff'];
        const playerSize = 30;
        const player1 = { x: 0, y: 0, color: '#00ffff', trail: [], lastShot: 0 };
        const player2 = { x: 0, y: 0, color: '#ff00ff', trail: [], lastShot: 0 };

        let obstacles = [];
        let particles = [];
        let bullets = [];

        // --- SES MOTORU ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);

            if (type === 'click' || type === 'menu_move') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(type==='click'?600:400, t); 
                gain.gain.setValueAtTime(0.1, t); gain.gain.exponentialRampToValueAtTime(0.001, t + 0.1);
                osc.start(t); osc.stop(t + 0.1);
            } else if (type === 'select') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(400, t); osc.frequency.linearRampToValueAtTime(800, t+0.1);
                gain.gain.setValueAtTime(0.1, t); gain.gain.exponentialRampToValueAtTime(0.001, t + 0.1);
                osc.start(t); osc.stop(t + 0.1);
            } else if (type === 'shoot') {
                osc.type = 'square'; osc.frequency.setValueAtTime(800, t); osc.frequency.exponentialRampToValueAtTime(100, t + 0.15);
                gain.gain.setValueAtTime(0.1, t); gain.gain.exponentialRampToValueAtTime(0.01, t + 0.15);
                osc.start(t); osc.stop(t + 0.15);
            } else if (type === 'armor') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, t); 
                gain.gain.setValueAtTime(0.2, t); gain.gain.exponentialRampToValueAtTime(0.001, t + 0.1);
                osc.start(t); osc.stop(t + 0.1);
            }
        }

        // --- MEN√ú MANTIƒûI ---

        function updateMenuVisuals() {
            if (!modeScreen.classList.contains('hidden')) {
                document.getElementById('btnMode1').classList.toggle('selected', menuIndex === 0);
                document.getElementById('btnMode2').classList.toggle('selected', menuIndex === 1);
            }
        }

        function handleMenuInput(direction, isSelect) {
            const now = Date.now();
            if (now - lastGamepadInputTime < 200) return; 
            lastGamepadInputTime = now;

            if (!modeScreen.classList.contains('hidden')) {
                if (direction === 'down' || direction === 'right') menuIndex = 1;
                if (direction === 'up' || direction === 'left') menuIndex = 0;
                if (isSelect) selectMode(menuIndex + 1);
                else if (direction) playSound('menu_move');
                updateMenuVisuals();
            } 
            else if (!colorScreen.classList.contains('hidden')) {
                if (direction === 'right') selectedColorIndex = (selectedColorIndex + 1) % colors.length;
                if (direction === 'left') selectedColorIndex = (selectedColorIndex - 1 + colors.length) % colors.length;
                if (direction === 'down' && selectedColorIndex + 4 < colors.length) selectedColorIndex += 4;
                if (direction === 'up' && selectedColorIndex - 4 >= 0) selectedColorIndex -= 4;
                
                if (isSelect) confirmColorSelection();
                else if (direction) playSound('menu_move');
                
                updateColorGridVisuals();
            }
            else if (!startScreen.classList.contains('hidden')) {
                if (isSelect) startGame();
            }
            else if (!gameOverScreen.classList.contains('hidden')) {
                if (isSelect) resetToMenu();
            }
        }

        function selectMode(mode) {
            gameMode = mode;
            modeScreen.classList.add('hidden');
            currentPlayerSelecting = 1;
            selectedColorIndex = 0;
            menuIndex = 0;
            setupColorSelection(1);
            playSound('select');
        }

        function setupColorSelection(playerNum) {
            currentPlayerSelecting = playerNum;
            colorScreen.classList.remove('hidden');
            const title = document.getElementById('colorTitle');
            const grid = document.getElementById('colorGrid');
            grid.innerHTML = '';

            title.innerText = (gameMode === 1 || isPortrait) ? "Geminin Rengini Se√ß" : `Oyuncu ${playerNum} Rengi`;
            title.style.color = '#fff';

            colors.forEach((c, index) => {
                const btn = document.createElement('div');
                btn.className = 'color-btn';
                btn.style.backgroundColor = c;
                btn.innerText = index + 1;
                
                const isTaken = (gameMode === 2 && !isPortrait && playerNum === 2 && player1.color === c);
                if (isTaken) btn.classList.add('color-taken');
                
                btn.onclick = () => {
                    if(isTaken) return;
                    selectedColorIndex = index;
                    updateColorGridVisuals();
                    confirmColorSelection();
                };
                grid.appendChild(btn);
            });
            updateColorGridVisuals();
        }

        function updateColorGridVisuals() {
            const btns = document.querySelectorAll('.color-btn');
            btns.forEach((btn, idx) => {
                if (idx === selectedColorIndex) btn.classList.add('focused');
                else btn.classList.remove('focused');
            });
        }

        function confirmColorSelection() {
            const chosenColor = colors[selectedColorIndex];
            if (gameMode === 2 && !isPortrait && currentPlayerSelecting === 2 && player1.color === chosenColor) return;

            playSound('select');
            
            if (gameMode === 1 || isPortrait) {
                player1.color = chosenColor;
                player2.color = chosenColor;
                finishSetup();
            } else {
                if (currentPlayerSelecting === 1) {
                    player1.color = chosenColor;
                    currentPlayerSelecting = 2;
                    selectedColorIndex = 0;
                    while(colors[selectedColorIndex] === player1.color) selectedColorIndex++;
                    setupColorSelection(2);
                } else {
                    player2.color = chosenColor;
                    finishSetup();
                }
            }
        }

        function finishSetup() {
            colorScreen.classList.add('hidden');
            updateUIColors();
            const modeHint = document.getElementById('modeHint');
            
            if (isPortrait) {
                modeHint.innerHTML = "Dƒ∞KEY MOD<br>Tek Kontrolc√º - T√ºm Gemileri Y√∂net";
            } else if (gameMode === 1) {
                modeHint.innerText = "1 OYUNCU: Her iki kontrol de aynƒ± gemiyi y√∂netir";
            } else {
                modeHint.innerText = "2 OYUNCU: Ekranƒ± payla≈üƒ±n, g√∂revinizi yapƒ±n";
            }
            
            startScreen.classList.remove('hidden');
        }

        function updateUIColors() {
            const leftBtns = document.querySelectorAll('.left-group .btn');
            const rightBtns = document.querySelectorAll('.right-group .btn');
            const cL = player1.color;
            const cR = (gameMode === 1 || isPortrait) ? player1.color : player2.color;

            leftBtns.forEach(b => {
                b.style.borderColor = cL; b.style.color = cL; b.style.boxShadow = `0 0 10px ${cL}40`;
                if(b.classList.contains('btn-fire')) b.style.backgroundColor = `${cL}20`;
            });

            rightBtns.forEach(b => {
                b.style.borderColor = cR; b.style.color = cR; b.style.boxShadow = `0 0 10px ${cR}40`;
                if(b.classList.contains('btn-fire')) b.style.backgroundColor = `${cR}20`;
            });
            
            document.querySelector('#readyTitle').style.background = `linear-gradient(90deg, ${cL}, ${cR})`;
            document.querySelector('#readyTitle').style.webkitTextFillColor = 'transparent';
            document.querySelector('#readyTitle').style.webkitBackgroundClip = 'text';
        }

        function resetToMenu() {
            isPlaying = false; isPaused = false;
            pauseOverlay.style.display = 'none';
            gameOverScreen.classList.add('hidden');
            startScreen.classList.add('hidden');
            colorScreen.classList.add('hidden');
            modeScreen.classList.remove('hidden');
            divider.style.opacity = '1';
            
            if(isPseudoFullscreen) {
                gameContainer.classList.remove('pseudo-fullscreen');
                isPseudoFullscreen = false;
                gameContainer.style.cursor = 'default';
                resizeCanvas();
            }
        }

        // --- OYUN D√ñNG√úS√ú VE Gƒ∞Rƒ∞≈ûLER ---

        const keys = { z: false, c: false, x: false, ArrowLeft: false, ArrowRight: false, ArrowDown: false };

        document.getElementById('startBtn').addEventListener('click', startGame);
        document.getElementById('restartBtn').addEventListener('click', resetToMenu);

        function startGame() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            isPlaying = true; isPaused = false;
            pauseBtn.innerText = '‚ùö‚ùö';
            pauseOverlay.style.display = 'none';
            score = 0; speed = 5; frames = 0;
            obstacles = []; particles = []; bullets = [];
            
            resizeCanvas(); 

            startScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            scoreDisplay.innerText = "0";
        }

        // Game Loop (S√ºrekli √áalƒ±≈üƒ±r, ancak mantƒ±k isPlaying/isPaused'a baƒülƒ±dƒ±r)
        function gameLoop() {
            requestAnimationFrame(gameLoop);
            
            const gp = pollGamepads();

            // Men√º Kontrolleri
            if (!isPlaying || isPaused) {
                if (gp) {
                    let dir = null;
                    if (gp.left) dir = 'left'; if (gp.right) dir = 'right';
                    if (gp.up) dir = 'up'; if (gp.down) dir = 'down';
                    
                    if (dir || gp.fire) handleMenuInput(dir, gp.fire);
                    else lastGamepadInputTime = 0;
                }
                return;
            }

            update(gp);
            draw();
        }

        // Gamepad Dinleme
        window.addEventListener("gamepadconnected", () => {
            gamepadStatus.style.display = 'block';
            setTimeout(() => gamepadStatus.style.display = 'none', 3000);
        });

        function pollGamepads() {
            const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
            if (!gamepads[0]) return null; 

            const gp = gamepads[0];
            const deadzone = 0.5;
            
            let left = gp.axes[0] < -deadzone || gp.buttons[14]?.pressed;
            let right = gp.axes[0] > deadzone || gp.buttons[15]?.pressed;
            let up = gp.axes[1] < -deadzone || gp.buttons[12]?.pressed;
            let down = gp.axes[1] > deadzone || gp.buttons[13]?.pressed;
            let fire = gp.buttons[0]?.pressed || gp.buttons[1]?.pressed || gp.buttons[2]?.pressed || gp.buttons[3]?.pressed;
            
            return { left, right, up, down, fire };
        }

        function update(gp) {
            const gpInput = gp || { left: false, right: false, fire: false };
            const moveSpeed = (canvas.width < 600) ? 6 : 9; 

            const p1L = keys.z || gpInput.left || (gameMode===1 && keys.ArrowLeft);
            const p1R = keys.c || gpInput.right || (gameMode===1 && keys.ArrowRight);
            const p1F = keys.x || gpInput.fire || (gameMode===1 && keys.ArrowDown);

            const p2L = keys.ArrowLeft;
            const p2R = keys.ArrowRight;
            const p2F = keys.ArrowDown;

            if (gameMode === 1 || isPortrait) {
                if (p1L && player1.x > 0) player1.x -= moveSpeed;
                if (p1R && player1.x < canvas.width - playerSize) player1.x += moveSpeed;
                if (p1F) fireBullet(player1, player1.x);

                if (frames % 3 === 0) {
                    player1.trail.push({x: player1.x, y: player1.y});
                    if(player1.trail.length > 8) player1.trail.shift();
                }
            } else {
                if (p1L && player1.x > 0) player1.x -= moveSpeed;
                if (p1R && player1.x < (canvas.width/2) - playerSize - 5) player1.x += moveSpeed;
                if (p1F) fireBullet(player1, player1.x);

                if (p2L && player2.x > (canvas.width/2) + 5) player2.x -= moveSpeed;
                if (p2R && player2.x < canvas.width - playerSize) player2.x += moveSpeed;
                if (p2F) fireBullet(player2, player2.x);

                if (frames % 3 === 0) {
                    player1.trail.push({x: player1.x, y: player1.y});
                    player2.trail.push({x: player2.x, y: player2.y});
                    if(player1.trail.length > 8) player1.trail.shift();
                    if(player2.trail.length > 8) player2.trail.shift();
                }
            }

            for(let i=bullets.length-1; i>=0; i--) {
                bullets[i].y -= 12;
                if(bullets[i].y < 0) bullets.splice(i,1);
            }

            let spawnRate = Math.max(20, 60 - Math.floor(score/100));
            if (frames % spawnRate === 0) {
                const type = Math.random();
                const obsSize = (canvas.width < 600) ? 30 : 40;
                const isArmored = Math.random() < 0.25; 
                
                if (gameMode === 1 || isPortrait) {
                    obstacles.push({
                        x: Math.random() * (canvas.width - obsSize), y: -50, w: obsSize, h: obsSize,
                        speed: speed + Math.random(), armored: isArmored, targetColor: player1.color, side: 'all'
                    });
                } else {
                    if (type < 0.6) obstacles.push({ side: 'left', x: Math.random()*((canvas.width/2)-obsSize), y: -50, w: obsSize, h: obsSize, speed: speed+Math.random(), armored: isArmored, targetColor: player1.color });
                    if (type > 0.4) obstacles.push({ side: 'right', x: (canvas.width/2) + Math.random()*((canvas.width/2)-obsSize), y: -50, w: obsSize, h: obsSize, speed: speed+Math.random(), armored: isArmored, targetColor: player2.color });
                }
            }

            for (let i = obstacles.length - 1; i >= 0; i--) {
                let obs = obstacles[i];
                obs.y += obs.speed;
                let hit = false;

                for (let j = bullets.length - 1; j >= 0; j--) {
                    let b = bullets[j];
                    let canHit = (gameMode === 1 || isPortrait) || (b.side === obs.side);
                    if (canHit && b.x > obs.x && b.x < obs.x+obs.w && b.y > obs.y && b.y < obs.y+obs.h) {
                        bullets.splice(j, 1);
                        if (obs.armored) {
                            playSound('armor'); createParticles(b.x, b.y, '#fff');
                        } else {
                            createParticles(obs.x+obs.w/2, obs.y+obs.h/2, obs.targetColor);
                            obstacles.splice(i, 1); hit = true; score += 20;
                            scoreDisplay.innerText = score;
                        }
                        break;
                    }
                }
                if (hit) continue;

                let players = (gameMode === 1 || isPortrait) ? [player1] : (obs.side === 'left' ? [player1] : [player2]);
                for (let p of players) {
                    if (p.x < obs.x + obs.w && p.x + playerSize > obs.x && p.y < obs.y + obs.h && p.y + playerSize > obs.y) {
                        createParticles(p.x + playerSize/2, p.y + playerSize/2, p.color);
                        gameOver(); return;
                    }
                }

                if (obs.y > canvas.height) {
                    obstacles.splice(i, 1); score += 10; scoreDisplay.innerText = score;
                    if (score % 300 === 0) speed += 0.5;
                }
            }

            for(let i=particles.length-1; i>=0; i--) {
                particles[i].x += particles[i].vx; particles[i].y += particles[i].vy;
                particles[i].life -= 0.05; if(particles[i].life <= 0) particles.splice(i, 1);
            }
            frames++;
        }

        function fireBullet(p, x) {
            if (Date.now() - p.lastShot > 250) {
                p.lastShot = Date.now();
                bullets.push({ x: x + playerSize/2, y: p.y, r: 4, color: p.color, side: (gameMode===2 && !isPortrait && p===player1)?'left':((gameMode===2 && !isPortrait)?'right':'all') });
                playSound('shoot');
            }
        }

        function draw() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.shadowBlur = 15;

            let players = (gameMode === 1 || isPortrait) ? [player1] : [player1, player2];
            players.forEach(p => {
                ctx.fillStyle = p.color; ctx.shadowColor = p.color;
                ctx.fillRect(p.x, p.y, playerSize, playerSize);
                ctx.shadowBlur = 0; ctx.lineWidth = 2; ctx.strokeStyle = p.color;
                ctx.beginPath(); p.trail.forEach((t,i)=>{ if(i===0)ctx.moveTo(t.x+15,t.y+15);else ctx.lineTo(t.x+15,t.y+15); }); ctx.stroke();
            });

            ctx.shadowBlur = 10;
            bullets.forEach(b => { ctx.fillStyle = b.color; ctx.shadowColor = b.color; ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI*2); ctx.fill(); });
            obstacles.forEach(o => {
                if(o.armored){ ctx.shadowBlur=0; ctx.fillStyle='#333'; ctx.strokeStyle='#aaa'; ctx.lineWidth=4; }
                else { ctx.shadowBlur=10; let c = (gameMode===1 || isPortrait) ? player1.color : (o.side==='left'?player1.color:player2.color); ctx.fillStyle=shadeColor(c,-50); ctx.shadowColor=c; ctx.strokeStyle=c; ctx.lineWidth=3; }
                ctx.fillRect(o.x, o.y, o.w, o.h); ctx.strokeRect(o.x, o.y, o.w, o.h);
            });
            ctx.shadowBlur = 0;
            particles.forEach(p => { ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, 4, 4); });
            ctx.globalAlpha = 1.0;
        }

        function createParticles(x,y,c) { for(let i=0;i<12;i++) particles.push({x, y, vx:(Math.random()-0.5)*12, vy:(Math.random()-0.5)*12, life:1, color:c}); }
        function shadeColor(color, percent) { /* Basitlik i√ßin orijinal rengi d√∂nd√ºr */ return color; }
        function gameOver() { isPlaying = false; finalScoreEl.innerText = score; gameOverScreen.classList.remove('hidden'); }

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            isPortrait = window.innerHeight > window.innerWidth;

            const controlHeight = isPortrait ? 150 : 100; 
            const targetY = canvas.height - controlHeight - playerSize - 20; 

            player1.y = targetY; player2.y = targetY;

            if (isPortrait) {
                controlsWrapper.classList.add('portrait-mode-controls');
                rightControls.classList.add('hidden'); divider.style.opacity = '0';
            } else {
                controlsWrapper.classList.remove('portrait-mode-controls');
                if (gameMode === 2) { rightControls.classList.remove('hidden'); divider.style.opacity = '1'; } 
                else { rightControls.classList.remove('hidden'); divider.style.opacity = '0'; }
            }
        }
        
        window.addEventListener('resize', resizeCanvas);
        document.addEventListener('fullscreenchange', () => {
            if (document.fullscreenElement) gameContainer.style.cursor = 'none';
            else gameContainer.style.cursor = 'default';
            resizeCanvas();
        });
        resizeCanvas();

        // Fullscreen ve Pause
        const toggleFullscreen = () => {
            if (document.fullscreenElement) { document.exitFullscreen(); return; }
            if (isPseudoFullscreen) { gameContainer.classList.remove('pseudo-fullscreen'); isPseudoFullscreen = false; gameContainer.style.cursor = 'default'; resizeCanvas(); return; }
            const req = gameContainer.requestFullscreen || gameContainer.webkitRequestFullscreen || gameContainer.msRequestFullscreen;
            if (req) { req.call(gameContainer).catch(() => { gameContainer.classList.add('pseudo-fullscreen'); isPseudoFullscreen = true; gameContainer.style.cursor = 'none'; resizeCanvas(); }); } 
            else { gameContainer.classList.add('pseudo-fullscreen'); isPseudoFullscreen = true; gameContainer.style.cursor = 'none'; resizeCanvas(); }
        };
        fullscreenBtn.addEventListener('click', toggleFullscreen);

        function togglePause() {
            if (!isPlaying) return;
            isPaused = !isPaused;
            pauseBtn.innerText = isPaused ? '‚ñ∂' : '‚ùö‚ùö';
            pauseOverlay.style.display = isPaused ? 'block' : 'none';
            if(!isPaused) { if (audioCtx.state === 'suspended') audioCtx.resume(); }
        }
        pauseBtn.addEventListener('click', togglePause);

        // Klavye Kontrolc√ºs√º
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && isPseudoFullscreen) toggleFullscreen();
            
            // Men√º
            if (!isPlaying || isPaused) {
                if (e.key === 'ArrowUp') handleMenuInput('up', false);
                else if (e.key === 'ArrowDown') handleMenuInput('down', false);
                else if (e.key === 'ArrowLeft') handleMenuInput('left', false);
                else if (e.key === 'ArrowRight') handleMenuInput('right', false);
                else if (e.key === 'Enter') handleMenuInput(null, true);
                else if (e.key >= '1' && e.key <= '8' && !colorScreen.classList.contains('hidden')) {
                    // Sayƒ±sal Renk Se√ßimi (Basit)
                    const idx = parseInt(e.key) - 1;
                    if(idx < colors.length) { selectedColorIndex = idx; updateColorGridVisuals(); confirmColorSelection(); }
                }
                else if (e.key === '1' && !modeScreen.classList.contains('hidden')) selectMode(1);
                else if (e.key === '2' && !modeScreen.classList.contains('hidden')) selectMode(2);
                return;
            }
            
            // Oyun i√ßi (S ve Yukarƒ± Ok Duraklatƒ±r)
            if ((e.key.toLowerCase() === 's' || e.key === 'ArrowUp') && isPlaying) { togglePause(); return; }
            
            if (e.key.toLowerCase() === 'z') keys.z = true;
            if (e.key.toLowerCase() === 'c') keys.c = true;
            if (e.key.toLowerCase() === 'x') keys.x = true;
            if (e.key === 'ArrowLeft') keys.ArrowLeft = true;
            if (e.key === 'ArrowRight') keys.ArrowRight = true;
            if (e.key === 'ArrowDown') keys.ArrowDown = true;
        });

        window.addEventListener('keyup', (e) => {
            if (e.key.toLowerCase() === 'z') keys.z = false;
            if (e.key.toLowerCase() === 'c') keys.c = false;
            if (e.key.toLowerCase() === 'x') keys.x = false;
            if (e.key === 'ArrowLeft') keys.ArrowLeft = false;
            if (e.key === 'ArrowRight') keys.ArrowRight = false;
            if (e.key === 'ArrowDown') keys.ArrowDown = false;
        });

        // Dokunmatik Kontroller
        document.querySelectorAll('.btn').forEach(btn => {
            const k = btn.dataset.key;
            btn.addEventListener('touchstart', (e)=>{ e.preventDefault(); keys[k]=true; btn.classList.add('active'); if(isPlaying) playSound('click'); });
            btn.addEventListener('touchend', (e)=>{ e.preventDefault(); keys[k]=false; btn.classList.remove('active'); });
            btn.addEventListener('mousedown', ()=>{ keys[k]=true; btn.classList.add('active'); if(isPlaying) playSound('click'); });
            btn.addEventListener('mouseup', ()=>{ keys[k]=false; btn.classList.remove('active'); });
        });

        // Ba≈ülat
        requestAnimationFrame(gameLoop);
        ctx.fillStyle = 'black'; ctx.fillRect(0,0,canvas.width, canvas.height);
    </script>
</body>
</html>


